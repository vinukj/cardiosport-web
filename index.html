<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fanplay CS Heart Rate Monitor </title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f0f4f8;
      color: #333;
      text-align: center;
    }
    .container {
      max-width: 900px;
      margin: 40px auto;
      padding: 32px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.08);
    }
    button {
      padding: 1rem 2rem;
      font-size: 1.2rem;
      cursor: pointer;
      background-color: #007bff;
      border: none;
      border-radius: 6px;
      color: white;
      margin-bottom: 1rem;
    }
    button:disabled {
      background-color: #999;
      cursor: not-allowed;
    }
    #heartRate {
      font-size: 3rem;
      margin-top: 1rem;
      color: #d9534f;
      font-weight: bold;
    }
    #status {
      margin-top: 1rem;
      font-style: italic;
      color: #555;
    }
    #chartContainer {
      width: 100%;
      max-width: 800px;
      margin: 40px auto 0 auto;
      background: #f8fafc;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #heartRateChart {
      width: 100%;
      height: 400px;
      max-width: 760px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>CardioSport Heart Rate Monitor</h1>
    <button id="scanButton">Scan for Heart Rate Devices</button>
    <div id="status"></div>
    <div id="heartRate">-- bpm</div>
    <div id="chartContainer">
      <canvas id="heartRateChart"></canvas>
    </div>
  </div>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Date adapter for time scale -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

  <script>
    const scanButton = document.getElementById('scanButton');
    const heartRateDisplay = document.getElementById('heartRate');
    const statusDisplay = document.getElementById('status');

    let bluetoothDevice;
    let heartRateCharacteristic;

    // Heart Rate Service UUID
    const HEART_RATE_SERVICE_UUID = 0x180D;
    // Heart Rate Measurement Characteristic UUID
    const HEART_RATE_MEASUREMENT_CHAR_UUID = 0x2A37;

    // Chart.js setup
    const ctx = document.getElementById('heartRateChart').getContext('2d');

    // Data arrays
    const timeLabels = [];
    const heartRateData = [];

    // Fixed window duration (60 seconds)
    const WINDOW_DURATION_MS = 60 * 1000;

    // Create Chart instance
    const heartRateChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: timeLabels,
        datasets: [{
          label: 'Heart Rate (bpm)',
          data: heartRateData,
          borderColor: '#d9534f',
          backgroundColor: 'rgba(217, 83, 79, 0.08)',
          fill: true,
          tension: 0.35,
          pointRadius: 0, // hide all points by default
          borderWidth: 3,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        layout: {
          padding: {
            left: 24,
            right: 24,
            top: 16,
            bottom: 16
          }
        },
        scales: {
          x: {
            type: 'time',
            time: {
              unit: 'second',
              displayFormats: {
                second: 'HH:mm:ss'
              }
            },
            title: {
              display: true,
              text: 'Time',
              font: { size: 16 }
            },
            grid: {
              color: '#e5e7eb'
            },
            min: null,
            max: null,
            ticks: {
              maxRotation: 0,
              autoSkip: true,
              maxTicksLimit: 10
            }
          },
          y: {
            min: 40,
            max: 180,
            title: {
              display: true,
              text: 'BPM',
              font: { size: 16 }
            },
            grid: {
              color: '#e5e7eb'
            }
          }
        },
        plugins: {
          legend: {
            display: true,
            labels: {
              color: '#333',
              font: {
                size: 14,
                weight: 'bold'
              }
            }
          },
          tooltip: {
            enabled: true,
            mode: 'nearest',
            intersect: false,
          }
        },
        elements: {
          point: {
            radius: 0 // hide points except the last one (drawn manually)
          }
        }
      },
      plugins: [{
        id: 'pulsatingDot',
        afterDatasetDraw(chart) {
          const {ctx} = chart;
          const meta = chart.getDatasetMeta(0);
          const dataset = chart.data.datasets[0];
          if (dataset.data.length === 0) return;

          const lastIndex = dataset.data.length - 1;
          const lastPoint = meta.data[lastIndex];
          if (!lastPoint) return;

          const radius = 10;
          const pulseRadius = radius + 6 * Math.abs(Math.sin(Date.now() / 400));

          ctx.save();

          // Draw pulsating circle
          ctx.beginPath();
          ctx.arc(lastPoint.x, lastPoint.y, pulseRadius, 0, 2 * Math.PI);
          ctx.fillStyle = 'rgba(217, 83, 79, 0.18)';
          ctx.fill();

          // Draw solid circle on top
          ctx.beginPath();
          ctx.arc(lastPoint.x, lastPoint.y, radius, 0, 2 * Math.PI);
          ctx.fillStyle = '#d9534f';
          ctx.shadowColor = 'rgba(217, 83, 79, 0.7)';
          ctx.shadowBlur = 12;
          ctx.fill();

          ctx.restore();

          // Animate pulsating dot
          requestAnimationFrame(() => chart.draw());
        }
      }]
    });

    scanButton.addEventListener('click', async () => {
      clearUI();
      statusDisplay.textContent = 'Requesting Bluetooth Device...';

      try {
        bluetoothDevice = await navigator.bluetooth.requestDevice({
          filters: [{ services: [HEART_RATE_SERVICE_UUID] }],
          optionalServices: [HEART_RATE_SERVICE_UUID]
        });

        statusDisplay.textContent = `Device selected: ${bluetoothDevice.name || 'Unnamed'}`;
        connectDeviceAndSubscribe();
      } catch (error) {
        statusDisplay.textContent = 'Error: ' + error.message;
      }
    });

    function clearUI() {
      heartRateDisplay.textContent = '-- bpm';
      statusDisplay.textContent = '';
      timeLabels.length = 0;
      heartRateData.length = 0;
      heartRateChart.options.scales.x.min = null;
      heartRateChart.options.scales.x.max = null;
      heartRateChart.update();
    }

    async function connectDeviceAndSubscribe() {
      if (!bluetoothDevice) return;

      bluetoothDevice.addEventListener('gattserverdisconnected', onDisconnected);

      try {
        statusDisplay.textContent = 'Connecting to GATT Server...';
        const server = await bluetoothDevice.gatt.connect();

        statusDisplay.textContent = 'Getting Heart Rate Service...';
        const service = await server.getPrimaryService(HEART_RATE_SERVICE_UUID);

        statusDisplay.textContent = 'Getting Heart Rate Measurement Characteristic...';
        heartRateCharacteristic = await service.getCharacteristic(HEART_RATE_MEASUREMENT_CHAR_UUID);

        statusDisplay.textContent = 'Starting notifications...';
        await heartRateCharacteristic.startNotifications();

        heartRateCharacteristic.addEventListener('characteristicvaluechanged', handleHeartRateChanged);

        statusDisplay.textContent = 'Connected and receiving heart rate data.';
      } catch (error) {
        statusDisplay.textContent = 'Connection failed: ' + error.message;
      }
    }

    function handleHeartRateChanged(event) {
      const value = event.target.value;
      const heartRate = parseHeartRate(value);
      heartRateDisplay.textContent = heartRate + ' bpm';

      const now = new Date();

      // Add new data point
      timeLabels.push(now);
      heartRateData.push(heartRate);

      // Remove old data outside the window
      while (timeLabels.length > 0 && (now - timeLabels[0]) > WINDOW_DURATION_MS) {
        timeLabels.shift();
        heartRateData.shift();
      }

      // Keep the x-axis fixed to the last WINDOW_DURATION_MS
      if (timeLabels.length > 0) {
        const lastTime = timeLabels[timeLabels.length - 1].getTime();
        heartRateChart.options.scales.x.min = new Date(lastTime - WINDOW_DURATION_MS);
        heartRateChart.options.scales.x.max = new Date(lastTime);
      }

      heartRateChart.update();
    }

    // Parse according to Bluetooth Heart Rate Measurement characteristic spec
    function parseHeartRate(dataView) {
      const flags = dataView.getUint8(0);
      const rate16Bits = flags & 0x1;

      let heartRate;
      if (rate16Bits) {
        heartRate = dataView.getUint16(1, true);
      } else {
        heartRate = dataView.getUint8(1);
      }
      return heartRate;
    }

    function onDisconnected() {
      statusDisplay.textContent = 'Device disconnected.';
      heartRateDisplay.textContent = '-- bpm';
    }
  </script>
</body>
</html>
