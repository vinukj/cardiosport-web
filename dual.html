<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fanplay IoT : Dual Heart Rate Monitor</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f0f4f8; color: #333; text-align: center; }
    .container { max-width: 1200px; margin: 40px auto; padding: 32px; background: #fff; border-radius: 16px; box-shadow: 0 4px 24px rgba(0,0,0,0.08); }
    .toggle-row { display: flex; align-items: center; justify-content: center; margin-bottom: 32px; gap: 12px; }
    .toggle-label { font-size: 1.1rem; }
    .charts-row { display: flex; flex-wrap: wrap; justify-content: center; gap: 32px; }
    .player {
      flex: 1 1 400px; min-width: 340px; max-width: 520px;
      background: #f8fafc; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      margin: 0 8px; padding: 24px 16px 32px 16px; display: flex; flex-direction: column; align-items: center;
    }
    .player-header { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
    .player-label { font-size: 1.3rem; font-weight: bold; margin-right: 8px; }
    .edit-name { font-size: 1rem; padding: 4px 8px; border-radius: 4px; border: 1px solid #ccc; margin-right: 4px; }
    .save-btn { font-size: 1rem; padding: 4px 12px; border-radius: 4px; border: none; background: #007bff; color: #fff; cursor: pointer; }
    button { padding: 1rem 2rem; font-size: 1.1rem; cursor: pointer; background-color: #007bff; border: none; border-radius: 6px; color: white; margin-bottom: 1rem; }
    button:disabled { background-color: #999; cursor: not-allowed; }
    .heartRate { font-size: 2.2rem; margin-top: 1rem; color: #d9534f; font-weight: bold; }
    .status { margin-top: 1rem; font-style: italic; color: #555; min-height: 1.5em; }
    .chart-container { width: 100%; max-width: 440px; height: 320px; margin-top: 18px; }
    .combined-chart-container { width: 100%; max-width: 900px; height: 400px; margin: 0 auto 32px auto; display: none; }
    canvas { background: #fff; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.04); }
    @media (max-width: 900px) {
      .charts-row { flex-direction: column; align-items: center; }
      .player { max-width: 98vw; }
      .combined-chart-container { max-width: 98vw; }
    }
    .switch { position: relative; display: inline-block; width: 54px; height: 28px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc; transition: .4s; border-radius: 28px;
    }
    .slider:before {
      position: absolute; content: ""; height: 22px; width: 22px; left: 3px; bottom: 3px;
      background-color: white; transition: .4s; border-radius: 50%;
    }
    input:checked + .slider { background-color: #007bff; }
    input:checked + .slider:before { transform: translateX(26px); }
  </style>
</head>
<body>
  <div class="container">
    <h1>Fanplay IoT : Dual Heart Rate Monitor</h1>
    <div class="toggle-row">
      <label class="switch">
        <input type="checkbox" id="toggleCombined">
        <span class="slider"></span>
      </label>
      <span class="toggle-label" id="toggleLabel">Show combined chart</span>
    </div>
    <div class="combined-chart-container" id="combinedChartContainer">
      <canvas id="combinedChart"></canvas>
    </div>
    <div class="charts-row" id="chartsRow">
      <div class="player" id="player1">
        <div class="player-header">
          <span class="player-label" id="player1Label">Player 1</span>
          <input class="edit-name" id="player1NameInput" type="text" placeholder="Enter name" />
          <button class="save-btn" id="player1SaveBtn">Save</button>
        </div>
        <button id="scan1">Connect</button>
        <div class="status" id="status1"></div>
        <div class="heartRate" id="heartRate1">-- bpm</div>
        <div class="chart-container">
          <canvas id="chart1"></canvas>
        </div>
      </div>
      <div class="player" id="player2">
        <div class="player-header">
          <span class="player-label" id="player2Label">Player 2</span>
          <input class="edit-name" id="player2NameInput" type="text" placeholder="Enter name" />
          <button class="save-btn" id="player2SaveBtn">Save</button>
        </div>
        <button id="scan2">Connect</button>
        <div class="status" id="status2"></div>
        <div class="heartRate" id="heartRate2">-- bpm</div>
        <div class="chart-container">
          <canvas id="chart2"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Date adapter for time scale -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script>
    // UUIDs for Heart Rate Service and Characteristic
    const HEART_RATE_SERVICE_UUID = 0x180D;
    const HEART_RATE_MEASUREMENT_CHAR_UUID = 0x2A37;

    // Chart window settings
    const WINDOW_DURATION_MS = 60 * 1000; // 60 seconds
    const RIGHT_PADDING_MS = 10 * 1000;   // 10 seconds of right-side space

    // Player state
    let device1 = null, char1 = null;
    let device2 = null, char2 = null;

    // Data arrays
    const timeLabels1 = [];
    const heartRateData1 = [];
    const timeLabels2 = [];
    const heartRateData2 = [];

    // DOM elements
    const scan1 = document.getElementById('scan1');
    const status1 = document.getElementById('status1');
    const heartRate1 = document.getElementById('heartRate1');
    const ctx1 = document.getElementById('chart1').getContext('2d');

    const scan2 = document.getElementById('scan2');
    const status2 = document.getElementById('status2');
    const heartRate2 = document.getElementById('heartRate2');
    const ctx2 = document.getElementById('chart2').getContext('2d');

    const toggleCombined = document.getElementById('toggleCombined');
    const toggleLabel = document.getElementById('toggleLabel');
    const chartsRow = document.getElementById('chartsRow');

    // Name logic
    let player1Name = "Player 1";
    let player2Name = "Player 2";

    const player1Label = document.getElementById('player1Label');
    const player1NameInput = document.getElementById('player1NameInput');
    const player1SaveBtn = document.getElementById('player1SaveBtn');

    const player2Label = document.getElementById('player2Label');
    const player2NameInput = document.getElementById('player2NameInput');
    const player2SaveBtn = document.getElementById('player2SaveBtn');

    // Chart.js configs
    function makeChartConfig(label, color, bgColor) {
      return {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: label,
            data: [],
            borderColor: color,
            backgroundColor: bgColor,
            fill: true,
            tension: 0.35,
            pointRadius: 0,
            borderWidth: 3,
            order: 1,
            spanGaps: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: false,
          scales: {
            x: {
              type: 'time',
              time: { unit: 'second', displayFormats: { second: 'HH:mm:ss' } },
              title: { display: true, text: 'Time', font: { size: 15 } },
              grid: { color: '#e5e7eb' },
              min: null,
              max: null,
              ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 10 }
            },
            y: {
              min: 40,
              max: 180,
              title: { display: true, text: 'BPM', font: { size: 15 } },
              grid: { color: '#e5e7eb' }
            }
          },
          plugins: {
            legend: { display: true, position: 'top' },
            tooltip: { enabled: true, mode: 'nearest', intersect: false }
          },
          elements: { point: { radius: 0 } }
        }
      };
    }

    // Individual charts
    const chart1 = new Chart(ctx1, makeChartConfig(
      player1Name, '#d9534f', 'rgba(217, 83, 79, 0.08)'
    ));
    const chart2 = new Chart(ctx2, makeChartConfig(
      player2Name, '#007bff', 'rgba(0, 123, 255, 0.08)'
    ));

    // Combined chart
    const combinedChartContainer = document.getElementById('combinedChartContainer');
    const ctxCombined = document.getElementById('combinedChart').getContext('2d');
    const combinedChart = new Chart(ctxCombined, {
      type: 'line',
      data: {
        labels: [],
        datasets: [
          {
            label: player1Name,
            data: [],
            borderColor: '#d9534f',
            backgroundColor: 'rgba(217, 83, 79, 0.08)',
            fill: false,
            tension: 0.35,
            pointRadius: 0,
            borderWidth: 3,
            order: 1,
            spanGaps: true
          },
          {
            label: player2Name,
            data: [],
            borderColor: '#007bff',
            backgroundColor: 'rgba(0, 123, 255, 0.08)',
            fill: false,
            tension: 0.35,
            pointRadius: 0,
            borderWidth: 3,
            order: 1,
            spanGaps: true
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        scales: {
          x: {
            type: 'time',
            time: { unit: 'second', displayFormats: { second: 'HH:mm:ss' } },
            title: { display: true, text: 'Time', font: { size: 15 } },
            grid: { color: '#e5e7eb' },
            min: null,
            max: null,
            ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 15 }
          },
          y: {
            min: 40,
            max: 180,
            title: { display: true, text: 'BPM', font: { size: 15 } },
            grid: { color: '#e5e7eb' }
          }
        },
        plugins: {
          legend: { display: true, position: 'top' },
          tooltip: { enabled: true, mode: 'nearest', intersect: false }
        },
        elements: { point: { radius: 0 } }
      }
    });

    // Toggle logic
    toggleCombined.addEventListener('change', () => {
      const combined = toggleCombined.checked;
      toggleLabel.textContent = combined ? 'Show individual charts' : 'Show combined chart';
      chartsRow.style.display = combined ? 'none' : 'flex';
      combinedChartContainer.style.display = combined ? 'block' : 'none';
      if (combined) updateCombinedChart();
    });

    // Save name handlers (fix: index into datasets)
    player1SaveBtn.addEventListener('click', () => {
      player1Name = player1NameInput.value.trim() || "Player 1";
      player1Label.textContent = player1Name;
      chart1.data.datasets[0].label = player1Name;
      chart1.update();
      combinedChart.data.datasets[0].label = player1Name;
      combinedChart.update();
    });

    player2SaveBtn.addEventListener('click', () => {
      player2Name = player2NameInput.value.trim() || "Player 2";
      player2Label.textContent = player2Name;
      chart2.data.datasets[0].label = player2Name;
      chart2.update();
      combinedChart.data.datasets[1].label = player2Name;
      combinedChart.update();
    });

    // --- BLE Connects ---
    scan1.addEventListener('click', async () => {
      clearUI(1);
      status1.textContent = 'Requesting Bluetooth Device...';
      try {
        if (!navigator.bluetooth) throw new Error('Web Bluetooth not supported in this browser.');
        device1 = await navigator.bluetooth.requestDevice({
          filters: [{ services: [HEART_RATE_SERVICE_UUID] }],
          optionalServices: [HEART_RATE_SERVICE_UUID]
        });
        status1.textContent = `Device selected: ${device1.name || 'Unnamed'}`;
        await connectAndSubscribe(device1, status1, heartRate1, timeLabels1, heartRateData1, chart1, 1);
      } catch (error) {
        status1.textContent = 'Error: ' + error.message;
      }
    });

    scan2.addEventListener('click', async () => {
      clearUI(2);
      status2.textContent = 'Requesting Bluetooth Device...';
      try {
        if (!navigator.bluetooth) throw new Error('Web Bluetooth not supported in this browser.');
        device2 = await navigator.bluetooth.requestDevice({
          filters: [{ services: [HEART_RATE_SERVICE_UUID] }],
          optionalServices: [HEART_RATE_SERVICE_UUID]
        });
        status2.textContent = `Device selected: ${device2.name || 'Unnamed'}`;
        await connectAndSubscribe(device2, status2, heartRate2, timeLabels2, heartRateData2, chart2, 2);
      } catch (error) {
        status2.textContent = 'Error: ' + error.message;
      }
    });

    // Connect to device, subscribe to notifications, and update UI/chart
    async function connectAndSubscribe(device, statusEl, heartRateEl, timeLabels, heartRateData, chart, playerNum) {
      device.addEventListener('gattserverdisconnected', () => {
        statusEl.textContent = 'Device disconnected.';
        heartRateEl.textContent = '-- bpm';
      });
      try {
        statusEl.textContent = 'Connecting to GATT Server...';
        const server = await device.gatt.connect();
        statusEl.textContent = 'Getting Heart Rate Service...';
        const service = await server.getPrimaryService(HEART_RATE_SERVICE_UUID);
        statusEl.textContent = 'Getting Heart Rate Measurement Characteristic...';
        const characteristic = await service.getCharacteristic(HEART_RATE_MEASUREMENT_CHAR_UUID);
        statusEl.textContent = 'Starting notifications...';
        await characteristic.startNotifications();
        characteristic.addEventListener('characteristicvaluechanged', event => {
          const value = event.target.value;
          const heartRate = parseHeartRate(value);
          heartRateEl.textContent = heartRate + ' bpm';

          const now = new Date();
          timeLabels.push(now);
          heartRateData.push(heartRate);

          // Trim old points outside the window (fix: look at first timestamp)
          while (timeLabels.length > 0 && (now - timeLabels[0]) > WINDOW_DURATION_MS) {
            timeLabels.shift();
            heartRateData.shift();
          }

          // Update chart (fix: index dataset)
          chart.data.labels = [...timeLabels];
          chart.data.datasets[0].data = [...heartRateData];

          // Keep x-axis fixed window with right padding
          if (timeLabels.length > 0) {
            const lastTime = timeLabels[timeLabels.length - 1].getTime();
            chart.options.scales.x.min = new Date(lastTime - WINDOW_DURATION_MS);
            chart.options.scales.x.max = new Date(lastTime + RIGHT_PADDING_MS);
          } else {
            chart.options.scales.x.min = null;
            chart.options.scales.x.max = null;
          }

          chart.update();
          if (toggleCombined.checked) updateCombinedChart();
        });
        statusEl.textContent = 'Connected and receiving heart rate data.';
        if (playerNum === 1) char1 = characteristic; else char2 = characteristic;
      } catch (error) {
        statusEl.textContent = 'Connection failed: ' + error.message;
      }
    }

    // Parse Heart Rate Measurement characteristic
    function parseHeartRate(dataView) {
      const flags = dataView.getUint8(0);
      const rate16Bits = flags & 0x1;
      return rate16Bits ? dataView.getUint16(1, true) : dataView.getUint8(1);
    }

    // Clear UI and chart for a player
    function clearUI(playerNum) {
      if (playerNum === 1) {
        heartRate1.textContent = '-- bpm';
        status1.textContent = '';
        timeLabels1.length = 0;
        heartRateData1.length = 0;
        chart1.data.labels = [];
        chart1.data.datasets[0].data = [];
        chart1.options.scales.x.min = null;
        chart1.options.scales.x.max = null;
        chart1.update();
      } else {
        heartRate2.textContent = '-- bpm';
        status2.textContent = '';
        timeLabels2.length = 0;
        heartRateData2.length = 0;
        chart2.data.labels = [];
        chart2.data.datasets[0].data = [];
        chart2.options.scales.x.min = null;
        chart2.options.scales.x.max = null;
        chart2.update();
      }
      if (toggleCombined.checked) updateCombinedChart();
    }

    // --- Combined Chart Logic ---
    function updateCombinedChart() {
      // Merge all unique timestamps from both players
      const allTimes = Array.from(new Set([...timeLabels1, ...timeLabels2].map(d => d.getTime())))
        .sort((a, b) => a - b)
        .map(t => new Date(t));

      // Map each timestamp to value or null (spanGaps true)
      const data1 = allTimes.map(t => {
        const idx = timeLabels1.findIndex(d => d.getTime() === t.getTime());
        return idx !== -1 ? heartRateData1[idx] : null;
      });
      const data2 = allTimes.map(t => {
        const idx = timeLabels2.findIndex(d => d.getTime() === t.getTime());
        return idx !== -1 ? heartRateData2[idx] : null;
      });

      combinedChart.data.labels = allTimes;
      combinedChart.data.datasets[0].data = data1; // fix: index dataset
      combinedChart.data.datasets[1].data = data2;

      // Set x-axis window
      if (allTimes.length > 0) {
        const lastTime = allTimes[allTimes.length - 1].getTime();
        combinedChart.options.scales.x.min = new Date(lastTime - WINDOW_DURATION_MS);
        combinedChart.options.scales.x.max = new Date(lastTime + RIGHT_PADDING_MS);
      } else {
        combinedChart.options.scales.x.min = null;
        combinedChart.options.scales.x.max = null;
      }

      // Ensure labels reflect latest names
      combinedChart.data.datasets[0].label = player1Name;
      combinedChart.data.datasets[1].label = player2Name;

      combinedChart.update();
    }
  </script>
</body>
</html>
